#!/usr/bin/env ruby

require 'bundler/setup'
require 'vic20'

require 'optparse'
require 'scanf'

options = {}

OptionParser.new do |opts|
  opts.banner = 'Usage: run [options] [firmware]'

  opts.on('-r', '--reset address', 'override reset vector') do |address, *|
    options[:reset] = address.to_i(16)
  end

  opts.on('-v', '--verbose', 'turn on verbose mode') do |v|
    options[:verbose] = v
  end
end.parse!

Vic20::Processor.prepend Vic20::Processor::Halt

if options[:verbose]
  Vic20::Processor.prepend Vic20::Processor::Trace
else
  Vic20::Processor.prepend Vic20::Processor::Report
end

memory = Vic20::Memory.new(ARGV[0])
processor = Vic20::Processor.new(memory)

processor.reset(options[:reset])

processor.run
