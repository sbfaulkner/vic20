#!/usr/bin/env ruby

require 'bundler/setup'
require 'vic20'

memory = Vic20::Memory.new
processor = Vic20::Processor.new(memory)

processor.reset

def format_assembly(method, addressing_mode, bytes)
  "; #{method.upcase} #{Vic20::Processor.format_operand(addressing_mode, bytes)}"
end

def format_instruction(address, method, addressing_mode, bytes)
  [
    format('%04X', address),
    bytes.map { |byte| format('%02X', byte) }.join(' ').ljust(8, ' '),
    format_assembly(method, addressing_mode, bytes),
  ].join('  ')
end

def verbose?
  @verbose ||= ARGV.include?('-v') || ARGV.include?('--verbose')
end

processor.each do |address, method, addressing_mode, bytes|
  if verbose?
    STDERR.puts processor.current_state
    STDERR.puts format_instruction(address, method, addressing_mode, bytes)
  end

  begin
    processor.send(method, addressing_mode, bytes)
  rescue
    unless verbose?
      STDERR.puts processor.current_state
      STDERR.puts format_instruction(address, method, addressing_mode, bytes)
    end
    raise
  end
end
